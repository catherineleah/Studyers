<script>
(function( $ ){
      $.fn.studyEditor = function() {
            var i = 0;
          var textArea = this.find('textarea');
            htmlCode = textArea.val();
            textArea.after('<div contentEditable="true" id="iView" style="float: left; width: 500px; min-height:400px">'+htmlCode+'</div> ');
            textArea.hide();
            var fd = document.getElementById('iView');
            fd.designMode = "on";
            
            
            
            $("#lesson_submit").click(function(){
            
                var oCanvas = document.getElementById("lesson-canvas");
                $("#lesson_attachment64").val(oCanvas.toDataURL());

                var saveHtml = $('#iView').html();
                //alert(saveHtml); return false;
                textArea.val(saveHtml);
      });
      	// Buttons
      	$('#buttons input[type="button"]').click(function() {
        	var cmd = $(this).attr('id');
          document.execCommand(cmd,false, null);
      	});
      };
})( jQuery );
function canvasInit() {
    context = document.getElementById("lesson-canvas").getContext("2d");
		var image = document.getElementById("canvas-image");
		$("#canvas-image").remove();
	  context.drawImage(image, 0, 0);
  $("#lesson-canvas").mousedown(function(e){
      var mouseX = e.pageX - this.offsetLeft;
      var mouseY = e.pageY - this.offsetTop;
            
      paint = true;
      addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
      redraw();
    });

   $("#lesson-canvas").mousemove(function(e){
      if(paint){
        addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
        redraw();
      }
    });

   $("#lesson-canvas").mouseup(function(e){
      paint = false;
    });

   $("#lesson-canvas").mouseleave(function(e){
      paint = false;
    });

   var clickX = new Array();
   var clickY = new Array();
   var clickDrag = new Array();
   var paint;

   function addClick(x, y, dragging)
   {
     clickX.push(x);
     clickY.push(y);
     clickDrag.push(dragging);
   }

   function redraw(){
      //canvas.width = canvas.width; // Clears the canvas
      
      context.strokeStyle = "#df4b26";
      context.lineJoin = "round";
      context.lineWidth = 2;
                
      for(var i=0; i < clickX.length; i++)
      {clickX
        context.beginPath();
        if(clickDrag[i] && i){
          context.moveTo(clickX[i-1], clickY[i-1]);
         }else{
           context.moveTo(clickX[i]-1, clickY[i]);
         }
         context.lineTo(clickX[i], clickY[i]);
         context.closePath();
         context.stroke();
      }
    }

}
</script>

<script>
$(document).ready(function() {
    $("form").studyEditor();
		canvasInit();
//		var canvas = document.getElementById("area");
//	    var context = canvas.getContext("2d");
	    
});
</script>
<div id="buttons">
    <input type="button" id="bold" value="Bold" `/>
    <input type="button" id="italic" value="Italic" />
</div>

<%= form_for([@notebook, @lesson]) do |f| %>
  <% if @lesson.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@lesson.errors.count, "error") %> prohibited this lesson from being saved:</h2>

      <ul>
      <% @lesson.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
	
  <div class="field">
    <%= f.label :title %><br />
    <%= f.text_field :title %>
  </div>
  <div class="field">
    <%= f.label :body %><br />
    <%= f.text_area :body %>
		
			<canvas class="canvas" id="lesson-canvas" width="500" height="500" style="float:right; margin: 5px; border: 1px solid red"></canvas>	

  </div>

  <div class="field" style="clear:both;">
    <%= f.label :permission %><br />
    <%= f.radio_button :permission, 0 %> Private
		<%= f.radio_button :permission, 1 %> Friends
		<%= f.radio_button :permission, 2 %> Public
  </div>
	<%= f.hidden_field :attachment64 %>
  <div class="actions">
    <%= f.submit %>
  </div>
	<% if @lesson.attachement.present? %>
		<%= image_tag @lesson.attachement.url, :id=>"canvas-image" %>
	<% end %>
<% end %>